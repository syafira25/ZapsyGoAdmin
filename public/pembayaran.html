<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ZapsyGo</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Remix Icon & FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="style2.css" />
    <link rel="stylesheet" href="styles.css" />

    <style>
      .summary-line {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
      }
            #preloader {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        z-index: 9999;
        background-color: #ffffff;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .spinner {
        width: 60px;
        height: 60px;
        border: 8px solid #eee;
        border-top: 8px solid #2560a3;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="d-flex flex-column min-vh-100" style="background-color: rgba(37, 96, 163, 0.3)">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top bg-white shadow-sm">
      <div class="container">
        <a class="navbar-brand fw-bold" href="#">ZapsyGo</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
          <ul class="navbar-nav gap-2 m-auto">
            <li class="nav-item"><a class="nav-link" href="index.html">BERANDA</a></li>
            <li class="nav-item"><a class="nav-link" href="about.html">TENTANG KAMI</a></li>
            <li class="nav-item"><a class="nav-link" href="itinerary.html">ITINERARY</a></li>
            <li class="nav-item"><a class="nav-link" href="destinasi.html">DESTINASI</a></li>
          </ul>
          <ul class="navbar-nav gap-2">
            <li class="nav-item" id="loginButton">
              <a class="btn fw-bold px-3" href="log2.html">MASUK</a>
            </li>
            <li class="nav-item dropdown d-none" id="profileDropdown">
              <a class="nav-link dropdown-toggle d-flex align-items-center gap-2" href="#" data-bs-toggle="dropdown"> <i class="fas fa-user-circle fs-4"></i> <span>Profil</span> </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="profile.html">Profil Saya</a></li>
                <li><hr class="dropdown-divider" /></li>
                <li><a class="dropdown-item text-danger" href="logout.html">Logout</a></li>
              </ul>
            </li>
          </ul>
        </div>
              </div>
          <div id="preloader">
      <div class="spinner"></div>
      </div>
    </nav>

    <!-- Konten Utama -->
    <div class="container" style="padding-top: 100px; padding-bottom: 50px">
      <div class="mb-4">
        <a href="javascript:history.back()" class="btn btn-kembali d-inline-flex align-items-center shadow px-4 py-2"> <i class="fas fa-arrow-left me-2"></i> Kembali </a>
      </div>

      <div class="row g-4">
        <!-- Kolom Kiri -->
        <div class="col-lg-7 d-flex flex-column gap-4">
          <div class="form-pax shadow p-4 rounded d-flex flex-column bg-white">
            <h2 class="fw-bold text-start mb-3 text-primary">Detail Pembayaran</h2>
            <img class="pembayaran-pict rounded-4 mb-3" src="assets/elyora.jpg" alt="Gambar Elyora" />
            <h5 class="fw-bold mb-3">TOUR 1 HARI ELYORA</h5>

            <div class="d-flex align-items-center gap-2 mb-4">
              <i class="ri-user-3-line text-primary fs-5"></i>
              <span id="paxDisplayLeft">- Pax</span>
            </div>
            <div class="d-flex align-items-center gap-2 mb-2">
              <i class="ri-calendar-line text-primary fs-5"></i>
              <span id="tanggalDisplay">-</span>
            </div>
          </div>
        </div>

        <!-- Kolom Kanan -->
        <div class="col-lg-5">
          <div class="custom-card bg-white shadow rounded p-4">
            <h5 class="fw-bold mb-4">Metode Pembayaran</h5>

            <div class="form-check mb-3">
              <label class="form-check-label radio-icon w-100 p-2 border rounded d-flex justify-content-between align-items-center" for="bca">
                <span>
                  <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f1/BCA_logo.svg/120px-BCA_logo.svg.png" width="50" alt="BCA" />
                  BCA Virtual Account
                </span>
                <input class="form-check-input" type="radio" name="bank" id="bca" checked />
              </label>
            </div>
            <div class="form-check mb-4">
              <label class="form-check-label radio-icon w-100 p-2 border rounded d-flex justify-content-between align-items-center" for="mandiri">
                <span>
                  <img src="https://upload.wikimedia.org/wikipedia/id/thumb/5/5f/Bank_Mandiri_logo.svg/1280px-Bank_Mandiri_logo.svg.png" width="50" alt="Mandiri" />
                  Mandiri Virtual Account
                </span>
                <input class="form-check-input" type="radio" name="bank" id="mandiri" />
              </label>
            </div>

            <!-- Ringkasan -->
            <h6 class="fw-bold mb-3">Cek ringkasan transaksimu, yuk</h6>
            <div class="summary-line">
              <span>Total harga (<span id="paxDisplaySummary">1 pax</span>)</span>
              <span id="totalHarga">Rp 300.000</span>
            </div>
            <div class="summary-line">
              <span>Biaya layanan</span>
              <span id="biayaLayanan">Rp 1.000</span>
            </div>
            <div class="summary-line fw-bold border-top pt-2 mt-2">
              <span>Total Tagihan</span>
              <span id="totalTagihan">Rp 301.000</span>
            </div>

            <p class="text-center small text-muted mb-3">Dengan melanjutkan pembayaran, kamu menyetujui S&amp;K perjalanan</p>
            <button class="btn btn-primary w-100 fw-bold rounded-pill py-2" onclick="simpanTagihan()">Bayar Sekarang</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="py-5 text-white mt-auto" style="background-color: #2560a3">
      <div class="container">
        <div class="row gy-4">
          <div class="col-md-4">
            <h5 class="fw-bold">ZapsyGo</h5>
            <p>Explore the world with ease and excitement through our comprehensive travel platform.</p>
            <div>
              <a href="#"><i class="ri-facebook-fill fs-5 text-white me-3"></i></a>
              <a href="#"><i class="ri-instagram-line fs-5 text-white me-3"></i></a>
              <a href="#"><i class="ri-youtube-line fs-5 text-white"></i></a>
            </div>
          </div>
          <div class="col-md-4">
            <h5 class="fw-bold">Akses Cepat</h5>
            <ul class="list-unstyled">
              <li><a href="index.html" class="text-white text-decoration-none">Beranda</a></li>
              <li><a href="#" class="text-white text-decoration-none">Destinasi</a></li>
              <li><a href="#" class="text-white text-decoration-none">Hotel</a></li>
              <li><a href="#" class="text-white text-decoration-none">Tentang Kami</a></li>
            </ul>
          </div>
          <div class="col-md-4">
            <h5 class="fw-bold">Kontak Kami</h5>
            <ul class="list-unstyled">
              <li><i class="ri-phone-fill me-2"></i> +62 918 2781 29</li>
              <li><i class="ri-record-mail-line me-2"></i> info@zapsygo</li>
              <li><i class="ri-map-pin-2-fill me-2"></i> Batam, Indonesia</li>
            </ul>
          </div>
        </div>
        <hr class="border-white opacity-25 my-4" />
        <p class="text-center small m-0">&copy; 2025 ZapsyGo. All rights reserved.</p>
      </div>
    </footer>

    <!-- SCRIPT -->
<script>
  // Preloader hide saat halaman selesai load
  window.addEventListener("load", function () {
    const preloader = document.getElementById("preloader");
    if (preloader) {
      preloader.style.opacity = "0";
      preloader.style.transition = "opacity 0.5s ease";
      setTimeout(() => {
        preloader.style.display = "none";
      }, 500);
    }
  });

  function formatRupiah(number) {
    return new Intl.NumberFormat("id-ID", {
      style: "currency",
      currency: "IDR",
      minimumFractionDigits: 0,
    }).format(number);
  }

  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  function updatePaxData(pax) {
    const hargaPerPax = 300000;
    const biayaLayanan = 1000;
    if (pax < 1) pax = 1;

    const totalHarga = hargaPerPax * pax;
    const totalTagihan = totalHarga + biayaLayanan;

    const paxText = pax + " Pax";
    document.getElementById("paxDisplayLeft").textContent = paxText;
    document.getElementById("paxDisplaySummary").textContent = paxText;
    document.getElementById("totalHarga").textContent = formatRupiah(totalHarga);
    document.getElementById("biayaLayanan").textContent = formatRupiah(biayaLayanan);
    document.getElementById("totalTagihan").textContent = formatRupiah(totalTagihan);

    return {
      pax: pax,
      totalHarga,
      totalTagihan,
      biayaLayanan,
    };
  }

  function simpanTagihan() {
    const paxText = document.getElementById("paxDisplayLeft").textContent || "1 Pax";
    const tanggal = document.getElementById("tanggalDisplay").textContent || new Date().toISOString().split("T")[0];
    const virtualAccount = "80777089237889088";

    const pax = parseInt(paxText) || 1;
    const tagihan = updatePaxData(pax);
    const timestamp = Date.now();

    const dataPesanan = {
      id_transaksi: "TRX" + timestamp,
      id_booking: "BK" + timestamp,
      nama_paket: "TOUR 1 HARI ELYORA",
      pax: pax,
      tanggal: tanggal,
      total_tagihan: tagihan.totalTagihan.toString().replace(/[^\d]/g, ""),
      virtual_account: virtualAccount,
      username: localStorage.getItem("username") || "",
      metode_pembayaran: document.querySelector('input[name="bank"]:checked')?.id || "bca"
    };

    fetch("http://localhost:5000/api/pemesanan", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(dataPesanan)
    })
      .then(res => res.json())
      .then(response => {
        const transaksi = response?.transaksi;

        if (transaksi) {
          localStorage.setItem("status_pesanan", JSON.stringify({
            id_transaksi: transaksi.id_transaksi,
            virtual_account: transaksi.virtual_account || virtualAccount,
            total_tagihan: transaksi.jumlah_transfer || dataPesanan.total_tagihan
          }));

          window.location.href = "status_pesanan.html";
        } else {
          alert("❌ Gagal menyimpan transaksi. Mohon coba lagi.");
        }
      })
      .catch(err => {
        console.error("❌ Error saat simpan transaksi:", err);
        alert("Terjadi kesalahan koneksi ke server.");
      });
  }

  document.addEventListener("DOMContentLoaded", function () {
    const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";
    const username = localStorage.getItem("username") || "Profil";

    const loginBtn = document.getElementById("loginButton");
    const profileDropdown = document.getElementById("profileDropdown");

    loginBtn.classList.toggle("d-none", isLoggedIn);
    profileDropdown.classList.toggle("d-none", !isLoggedIn);

    // Tampilkan foto profil dari server
    if (isLoggedIn) {
      fetch(`http://localhost:5000/api/profile?username=${username}`)
        .then(res => res.json())
        .then(data => {
          const dropdownLink = profileDropdown.querySelector("a.nav-link");
          let photoURL = data.photo;

          if (photoURL && !photoURL.startsWith("http")) {
            photoURL = `http://localhost:5000/uploads/${photoURL.split('\\').pop().split('/').pop()}`;
          }

          if (photoURL) {
            const icon = dropdownLink.querySelector("i");
            if (icon) icon.remove();

            dropdownLink.innerHTML = `
              <img src="${photoURL}" alt="Foto" class="rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover;">
              <span>${username}</span>
            `;
          } else {
            dropdownLink.innerHTML = `
              <i class="fas fa-user-circle fs-4"></i> <span>${username}</span>
            `;
          }
        })
        .catch(err => {
          console.error("Gagal memuat foto profil:", err);
        });
    }

    // Tampilkan data tagihan
    const paxParam = parseInt(getQueryParam("pax")) || 1;
    const tanggalParam = getQueryParam("tanggal");
    const tanggalFinal = tanggalParam || new Date().toISOString().split("T")[0];

    document.getElementById("tanggalDisplay").textContent = tanggalFinal;
    updatePaxData(paxParam);

    // Jika ada status pesanan tersimpan
    const data = JSON.parse(localStorage.getItem("status_pesanan"));
    if (data) {
      const pax = data.pax || 1;
      const tanggal = data.tanggal || new Date().toISOString().split("T")[0];

      document.getElementById("tanggalDisplay").textContent = tanggal;
      updatePaxData(pax);

      const modalVA = document.getElementById("modalVirtualAccount");
      const modalTagihan = document.getElementById("modalTagihan");

      if (modalVA) modalVA.textContent = data.virtual_account;
      if (modalTagihan) modalTagihan.textContent = formatRupiah(parseInt(data.total_tagihan));
    }
  });
</script>

  </body>
</html>
