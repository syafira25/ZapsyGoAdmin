<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kelola Destinasi - ZapsyGo Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="admin.css" />
        <style>
      #preloader {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        z-index: 9999;
        background-color: #ffffff;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .spinner {
        width: 60px;
        height: 60px;
        border: 8px solid #eee;
        border-top: 8px solid #2560a3;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar dan Header -->
        <div class="d-md-none bg-primary text-white p-2 d-flex justify-content-between align-items-center">
          <button class="btn btn-light btn-sm" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar">☰ Menu</button>
          <span>ZapsyGo Admin</span>
        </div>
        <div class="col-md-2 d-none d-md-flex flex-column sidebar p-0">
          <h4 class="text-white text-center py-3 border-bottom">ZapsyGo Admin</h4>
          <a href="index.html">🏠 Dashboard</a>
          <a href="kelola_destinasi.html" class="active">📍 Kelola Destinasi</a>
          <a href="kelola_itinerary.html">📅 Kelola Itinerary</a>
          <a href="kelola_booking.html">📂 Kelola Booking</a>
          <a href="kelola_transaksi.html">💳 Kelola Transaksi</a>
          <a href="kelola_customer.html">👤 Kelola Customer</a>
          <a href="login.html" class="mt-auto text-danger border-top">🚪 Logout</a>
        </div>
        <div class="offcanvas offcanvas-start sidebar d-md-none" tabindex="-1" id="mobileSidebar">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title text-white">ZapsyGo Admin</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
          </div>
          <div class="offcanvas-body p-0">
            <a href="index.html">🏠 Dashboard</a>
            <a href="kelola_destinasi.html" class="active">📍 Kelola Destinasi</a>
            <a href="kelola_itinerary.html">📅 Kelola Itinerary</a>
            <a href="kelola_booking.html">📂 Kelola Booking</a>
            <a href="kelola_transaksi.html">💳 Kelola Transaksi</a>
            <a href="kelola_customer.html">👤 Kelola Customer</a>
            <a href="kelola_halaman.html">🌐 Kelola Halaman</a>
            <a href="login.html" class="mt-auto text-danger border-top">🚪 Logout</a>
          </div>
        </div>

        <!-- Main Content -->
        <div class="col-12 col-md-10 content">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Kelola Destinasi</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalTambahDestinasi">+ Tambah Destinasi</button>
          </div>

          <!-- Pencarian -->
          <div class="mb-3">
            <input type="text" id="searchInput" class="form-control" placeholder="🔍 Cari destinasi..." />
          </div>

          <!-- Tabel Destinasi -->
          <div class="table-responsive bg-white shadow-sm rounded p-3">
            <table id="destinasiTable" class="table table-bordered table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>No</th>
                  <th>Nama Destinasi</th>
                  <th>Lokasi</th>
                  <th>Deskripsi</th>
                  <th>Foto</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody>
                <!-- Akan diisi dinamis dengan JS -->
              </tbody>
            </table>
          </div>

          <!-- Modal Tambah Destinasi -->
          <div class="modal fade" id="modalTambahDestinasi" tabindex="-1" aria-labelledby="modalTambahDestinasiLabel" aria-hidden="true">
            <div class="modal-dialog">
              <form id="formTambahDestinasi" class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="modalTambahDestinasiLabel">Tambah Destinasi</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label for="namaDestinasi" class="form-label">Nama Destinasi</label>
                    <input type="text" class="form-control" id="namaDestinasi" required />
                  </div>
                  <div class="mb-3">
                    <label for="lokasiDestinasi" class="form-label">Lokasi</label>
                    <input type="text" class="form-control" id="lokasiDestinasi" required />
                  </div>
                  <div class="mb-3">
                    <label for="deskripsiDestinasi" class="form-label">Deskripsi</label>
                    <textarea class="form-control" id="deskripsiDestinasi" rows="3" required></textarea>
                  </div>
                  <div class="mb-3">
  <label for="fotoDestinasi" class="form-label">Foto</label>
  <input type="file" class="form-control" id="fotoDestinasi" accept="image/*" required />
</div>
                </div>
                <div class="modal-footer">
                  <button type="submit" class="btn btn-primary">Simpan</button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                </div>
              </form>
            </div>
          </div>
          <!-- Modal Edit Destinasi -->
<div class="modal fade" id="modalEditDestinasi" tabindex="-1" aria-labelledby="modalEditDestinasiLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="formEditDestinasi" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Destinasi</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editIndex" />
        <div class="mb-3">
          <label for="editNama" class="form-label">Nama Destinasi</label>
          <input type="text" class="form-control" id="editNama" required />
        </div>
        <div class="mb-3">
          <label for="editLokasi" class="form-label">Lokasi</label>
          <input type="text" class="form-control" id="editLokasi" required />
        </div>
        <div class="mb-3">
          <label for="editDeskripsi" class="form-label">Deskripsi</label>
          <textarea class="form-control" id="editDeskripsi" rows="3" required></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">Simpan Perubahan</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
      </div>
    </form>
  </div>
</div>
            <!-- Preloader -->
    <div id="preloader">
      <div class="spinner"></div>
      </div>
        </div>
      </div>
    </div>

    <!-- JavaScript -->
<script>

      // Preloader hide saat halaman selesai load
      window.addEventListener("load", function () {
        const preloader = document.getElementById("preloader");
        if (preloader) {
          preloader.style.opacity = "0";
          preloader.style.transition = "opacity 0.5s ease";
          setTimeout(() => {
            preloader.style.display = "none";
          }, 500);
        }
      });

  const BASE_URL = 'http://localhost:5000';

  // 🔍 Pencarian destinasi
  document.getElementById("searchInput").addEventListener("keyup", function () {
    const input = this.value.toLowerCase();
    const rows = document.querySelectorAll("#destinasiTable tbody tr");

    rows.forEach((row) => {
      const nama = row.cells[1].textContent.toLowerCase();
      const lokasi = row.cells[2].textContent.toLowerCase();
      const deskripsi = row.cells[3].textContent.toLowerCase();

      row.style.display = (nama.includes(input) || lokasi.includes(input) || deskripsi.includes(input)) ? "" : "none";
    });
  });

  // ✏️ Isi form edit
  function isiFormEdit(index, data) {
    document.getElementById("editIndex").value = index;
    document.getElementById("editNama").value = data.nama;
    document.getElementById("editLokasi").value = data.lokasi;
    document.getElementById("editDeskripsi").value = data.deskripsi;
    const modal = new bootstrap.Modal(document.getElementById("modalEditDestinasi"));
    modal.show();
  }

  // ✅ Submit form edit destinasi
  document.getElementById("formEditDestinasi").addEventListener("submit", async function (e) {
    e.preventDefault();
    const index = document.getElementById("editIndex").value;
    const nama = document.getElementById("editNama").value;
    const lokasi = document.getElementById("editLokasi").value;
    const deskripsi = document.getElementById("editDeskripsi").value;

    try {
      const res = await fetch(`${BASE_URL}/api/destinasi/${index}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nama, lokasi, deskripsi })
      });

      const result = await res.json();
      if (res.ok) {
        alert("✅ Data berhasil diperbarui");
        bootstrap.Modal.getInstance(document.getElementById("modalEditDestinasi")).hide();
        loadDestinasi();
      } else {
        alert(result.message || "❌ Gagal memperbarui data");
      }
    } catch (err) {
      console.error(err);
      alert("❌ Terjadi kesalahan saat memperbarui data");
    }
  });

  // 📥 Tampilkan data destinasi
  async function loadDestinasi() {
    const tbody = document.querySelector("#destinasiTable tbody");
    tbody.innerHTML = '';

    try {
      const res = await fetch(`${BASE_URL}/api/destinasi`);
      const data = await res.json();

      data.forEach((item, index) => {
        tbody.innerHTML += `
          <tr>
            <td>${index + 1}</td>
            <td>${item.nama}</td>
            <td>${item.lokasi}</td>
            <td>${item.deskripsi}</td>
            <td><img src="${BASE_URL}${item.foto}" class="img-thumbnail" width="60"/></td>
            <td>
              <button class="btn btn-sm btn-warning" onclick='isiFormEdit(${index}, ${JSON.stringify(item)})'>✏️ Edit</button>
              <button class="btn btn-sm btn-danger" onclick="hapusDestinasi(${index})">❌ Hapus</button>
            </td>
          </tr>`;
      });
    } catch (err) {
      console.error("❌ Gagal memuat data destinasi", err);
    }
  }
  function formatRupiah(number) {
  return new Intl.NumberFormat("id-ID", {
    style: "currency",
    currency: "IDR",
    minimumFractionDigits: 0,
  }).format(number);
}

  // ➕ Tambah destinasi baru
  document.getElementById('formTambahDestinasi').addEventListener('submit', async function (e) {
    e.preventDefault();

    const formData = new FormData();
    formData.append("nama", document.getElementById("namaDestinasi").value);
    formData.append("lokasi", document.getElementById("lokasiDestinasi").value);
    formData.append("deskripsi", document.getElementById("deskripsiDestinasi").value);
    formData.append("foto", document.getElementById("fotoDestinasi").files[0]);

    try {
      const res = await fetch(`${BASE_URL}/api/destinasi-upload`, {
        method: 'POST',
        body: formData
      });

      const result = await res.json();
      if (res.ok) {
        alert('✅ Destinasi berhasil ditambahkan');
        this.reset();
        bootstrap.Modal.getInstance(document.getElementById("modalTambahDestinasi")).hide();
        loadDestinasi();
      } else {
        alert(result.message || '❌ Terjadi kesalahan');
      }
    } catch (err) {
      alert('❌ Gagal mengirim data');
      console.error(err);
    }
  });

  // 🗑️ Hapus destinasi
  async function hapusDestinasi(index) {
    if (!confirm("Yakin ingin menghapus destinasi ini?")) return;

    try {
      const res = await fetch(`${BASE_URL}/api/destinasi/${index}`, {
        method: 'DELETE'
      });
      const result = await res.json();

      if (res.ok) {
        alert("✅ Destinasi berhasil dihapus");
        loadDestinasi();
      } else {
        alert(result.message || "❌ Gagal menghapus destinasi");
      }
    } catch (err) {
      alert("❌ Terjadi kesalahan saat menghapus");
      console.error(err);
    }
  }

  // 🚀 Load saat halaman dibuka
  window.addEventListener('DOMContentLoaded', loadDestinasi);
</script>

<!-- Bootstrap Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  </body>
</html>
